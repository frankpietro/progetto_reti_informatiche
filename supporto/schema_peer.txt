SCHEMA PEER

select per monitorare arrivo informazioni
se informazioni dal socket {
    ricevo e leggo pacchetto UDP
    se dal server {
        se cambio lista vicini {
            leggo i nuovi vicini
            modifico la lista di neighbors attraverso uno switch
            invio ack
        }
        se spegnimento server {
            //gestisco i dati
            invio ack
            chiudo il socket
            esco
        }
    }
    se da un vicino {
        se richiesta di aggregato {
            invio ack
            leggo i dati arrivati
            controllo se ho il dato richiesto (aggregato del tipo richiesto calcolato sulle entry richieste)
            se non ho il dato {
                se ho un vicino solo
                    invio reply con 0 (e' lui che ha fatto la richiesta)
                se ho piu' di un vicino {
                    se il prossimo vicino e' quello da cui e' partita la richiesta
                        invio reply con 0
                    altrimenti
                        gli giro il messaggio arrivato a me
                }
            }
            se ho il dato
                lo invio direttamente a chi lo ha chiesto
        }
    }
}

se informazioni da stdin {
    se help
        stampo i comandi
    se start {
        invio richiesta di connessione al server
        ricevo la lista
        invio ack
        aggiungo i vicini

    }
    se add {
        controllo che il peer sia connesso
        controllo che i dati siano corretti
        aggiorno l'orario
        inserisco l'entry in un file chiamato <data>_<porta>.txt
        invio messaggio del tipo giusto di nuova entry al server
    }
    se get {
        controllo gli input
        invio richiesta numero entries del giorno al server
        ricevo numero entries del giorno
        se zero
            niente da calcolare
        altrimenti se uguale a quello posseduto {
            calcolo il totale
            lo scrivo su un file
        }
        altrimenti {
            se ho zero vicini
                impossibile ottenere il dato richiesto
            altrimenti {
                invio richiesta dati aggregati con nome porta, tipo e numero entries attuali
                ricevo risposta
                se contiene un numero positivo
                    lo scrivo su un file
                se contiene 0 {
                    //...............................................................................
                }
            }
        }
    }
    se stop {
        //Gestisce i dati
        invio messaggio di uscita
        chiudo il socket
        esco
    }
}
